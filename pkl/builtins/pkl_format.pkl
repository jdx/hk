import "../Builtins.pkl"
import "../Config.pkl"
import "./test/helpers.pkl"

@Builtins.meta {
  category = "Configuration"
  description = "Pkl formatter"
}
pkl_format = new Config.Step {
  glob = "**/*.pkl"
  stage = "<JOB_FILES>"
  check_list_files = "pkl format --diff-name-only {{ files }}"
  // NB: pkl format exits 11 even if it fixes files
  //  (If you're using a version of pkl that includes https://github.com/apple/pkl/pull/1340
  //  you can override this command to just use `pkl format --write {{ files }}`
  //  and remove the `shell` definition)
  shell = "sh -c"
  fix =
    """
        pkl format --write {{ files }}
        code=$?
        if [ $code -eq 11 ]; then
            exit 0
        else
            exit $code
        fi
    """
  tests {
    ...new helpers.Fix {
      filename = "test.pkl"
      before = "x = new {  }"
      after = "x = new {}\n"
      check_failure_code = 11
    }.suite
  }
}
