import "../Config.pkl"

detect_private_key = new Config.Step {
    glob = "**/*"
    check = "hk util detect-private-key {{files}}"
    tests {
        ["detects RSA private key"] {
            run = "check"
            write {
                ["{{tmp}}/id_rsa"] = """
                    -----BEGIN RSA PRIVATE KEY-----
                    MIIEpAIBAAKCAQEA...
                    -----END RSA PRIVATE KEY-----
                    """
            }
            files = List("{{tmp}}/id_rsa")
            expect { code = 1 }
        }
        ["detects OpenSSH private key"] {
            run = "check"
            write {
                ["{{tmp}}/id_ed25519"] = """
                    -----BEGIN OPENSSH PRIVATE KEY-----
                    b3BlbnNzaC1rZXktdjEAAAAABG5vbmU...
                    -----END OPENSSH PRIVATE KEY-----
                    """
            }
            files = List("{{tmp}}/id_ed25519")
            expect { code = 1 }
        }
        ["passes public key"] {
            run = "check"
            write {
                ["{{tmp}}/id_rsa.pub"] = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC... user@host"
            }
            files = List("{{tmp}}/id_rsa.pub")
            expect { code = 0 }
        }
        ["passes clean file"] {
            run = "check"
            write {
                ["{{tmp}}/clean.txt"] = "Hello, world!"
            }
            files = List("{{tmp}}/clean.txt")
            expect { code = 0 }
        }
    }
}
