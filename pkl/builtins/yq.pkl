import "../Builtins.pkl"
import "../Config.pkl"
import "./test/helpers.pkl"

@Builtins.meta {
  category = "Data Formats"
  description = "YAML processor"
}
yq = new Config.Step {
  glob = List("**/*.yaml", "**/*.yml")
  stage = "<JOB_FILES>"
  check_diff =
    """
    failed=0
    for f in {{ files }}; do
      yq -P "$f" | diff -u "$f" - || failed=1
    done
    exit $failed
    """
  fix = "yq -iP {{ files }}"
  tests {
    ...new helpers.Fix {
      filename = "test.yaml"
      before = "foo:  bar"
      after = "foo: bar\n"
    }.suite
  }
}
