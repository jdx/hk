#!/usr/bin/env bash
set -euo pipefail

# Generate rich release notes for GitHub releases using Claude Code
# Usage: mise run gen-release-notes <version> [prev_version]

version="${1:-}"
prev_version="${2:-}"

if [[ -z $version ]]; then
	echo "Usage: mise run gen-release-notes <version> [prev_version]" >&2
	exit 1
fi

# Get the git-cliff changelog for context
# Use the tag range if prev_version provided, otherwise unreleased
if [[ -n $prev_version ]]; then
	changelog=$(git cliff --strip all "${prev_version}..${version}" 2>/dev/null || echo "")
else
	changelog=$(git cliff --unreleased --strip all 2>/dev/null || echo "")
fi

if [[ -z $changelog ]]; then
	echo "Error: No changes found for release" >&2
	exit 1
fi

# Build prompt safely using printf to avoid command substitution on backticks in changelog
prompt=$(
	printf '%s\n' "You are writing release notes for hk version ${version}${prev_version:+ (previous version: ${prev_version})}."
	printf '\n'
	printf '%s\n' "hk is a git hook manager and project linting tool written in Rust with emphasis on performance and concurrent execution."
	printf '\n'
	printf '%s\n' "Here is the raw changelog from git-cliff:"
	printf '%s\n' "$changelog"
	printf '\n'
	cat <<INSTRUCTIONS
Write user-friendly release notes with a creative title.

FORMAT - Your output MUST start with this exact line format:
# $version - <Creative Title>

Where <Creative Title> is 2-6 words capturing the theme of the release (e.g., "Hook Line and Sinker", "Parallel Universe", "Lock and Load").

After the title line, write the release notes:
1. Start with 1-2 paragraphs summarizing key changes
2. Organize into ### sections (Highlights, Bug Fixes, etc.)
3. Explain WHY changes matter to users
4. Include PR links and documentation links (https://hk.jdx.dev/)
5. Include contributor usernames (@username)
6. Skip internal changes
INSTRUCTIONS
)

# Use Claude Code to generate the release notes
# Sandboxed: only read-only tools allowed (no Bash, Edit, Write)
echo "Generating release notes with Claude..." >&2
echo "Version: $version" >&2
echo "Previous version: ${prev_version:-none}" >&2
echo "Changelog length: ${#changelog} chars" >&2

# Capture stderr separately to avoid polluting output
stderr_file=$(mktemp)
trap 'rm -f "$stderr_file"' EXIT

if ! output=$(
	printf '%s' "$prompt" | claude -p \
		--model claude-opus-4-5-20251101 \
		--permission-mode bypassPermissions \
		--output-format text \
		--allowedTools "Read,Grep,Glob" 2>"$stderr_file"
); then
	echo "Error: Claude CLI failed" >&2
	cat "$stderr_file" >&2
	exit 1
fi

# Validate we got non-empty output
if [[ -z $output ]]; then
	echo "Error: Claude returned empty output" >&2
	cat "$stderr_file" >&2
	exit 1
fi

# Strip any preamble before the "# vX.X.X -" line
output=$(echo "$output" | sed -n '/^# v[0-9]/,$p')

# Validate we got the expected format
if [[ -z $output ]]; then
	echo "Error: No '# vX.X.X -' line found in Claude output" >&2
	exit 1
fi

# Output the release notes (title line + body)
echo "$output"
echo ""
echo "<details>"
echo "<summary>Changelog</summary>"
echo ""
echo "$changelog"
echo "</details>"
