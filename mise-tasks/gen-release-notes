#!/usr/bin/env bash
#MISE description="Generate editorialized release notes with Claude Code"
#USAGE arg "<version>" help="Git tag/version to generate notes for"
#USAGE arg "<output_dir>" help="Directory to write title and notes files"
#USAGE arg "[prev_version]" help="Previous version"
set -euo pipefail

version="${usage_version}"
output_dir="${usage_output_dir}"
prev_version="${usage_prev_version:-}"

mkdir -p "$output_dir"

# Get the git-cliff changelog for context
if [[ -n $prev_version ]]; then
	changelog=$(git cliff --strip all "${prev_version}..${version}" 2>/dev/null || echo "")
else
	changelog=$(git cliff --unreleased --strip all 2>/dev/null || echo "")
fi

if [[ -z $changelog ]]; then
	echo "Error: No changes found for release"
	exit 1
fi

# Build prompt safely using printf to avoid command substitution on backticks in changelog
prompt=$(
	printf '%s\n' "You are writing release notes for hk version ${version}${prev_version:+ (previous version: ${prev_version})}."
	printf '\n'
	printf '%s\n' "hk is a git hook manager and project linting tool written in Rust with emphasis on performance and concurrent execution."
	printf '\n'
	printf '%s\n' "Here is the raw changelog from git-cliff:"
	printf '%s\n' "$changelog"
	printf '\n'
	cat <<INSTRUCTIONS
Write user-friendly release notes with a creative title.

FORMAT - Your output MUST start with this exact line format:
# $version - <Creative Title>

Where <Creative Title> is 2-6 words capturing the theme of the release (e.g., "Hook Line and Sinker", "Parallel Universe", "Lock and Load").
For smaller or less impactful releases, keep the title understated and modest.

TONE CALIBRATION:
- Match the tone and length to the actual significance of the changes
- If the release is mostly small bug fixes or minor tweaks, be upfront about thatâ€”a sentence or two of summary is fine, don't write multiple paragraphs inflating the importance
- Reserve enthusiastic, detailed write-ups for releases with genuinely significant features or changes
- It's okay to say "This is a smaller release focused on bug fixes" when that's the case

After the title line, write the release notes:
1. Start with a summary proportional to the significance of the changes
2. Organize into ### sections (Highlights, Bug Fixes, etc.)
3. Explain WHY changes matter to users
4. Include PR links and documentation links (https://hk.jdx.dev/)
5. Include contributor usernames (@username). Do not thank @jdx since that is who is writing these notes.
6. Skip internal changes
INSTRUCTIONS
)

# Use Claude Code to generate the release notes
echo "Generating release notes with Claude..."
echo "Version: $version"
echo "Previous version: ${prev_version:-none}"
echo "Changelog length: ${#changelog} chars"

if ! output=$(
	printf '%s' "$prompt" | claude -p \
		--model claude-opus-4-5-20251101 \
		--permission-mode bypassPermissions \
		--output-format text \
		--allowedTools "Read,Grep,Glob"
); then
	echo "Error: Claude CLI failed"
	exit 1
fi

# Validate we got non-empty output
if [[ -z $output ]]; then
	echo "Error: Claude returned empty output"
	exit 1
fi

# Strip any preamble before the "# vX.X.X -" line
output=$(echo "$output" | sed -n '/^# v[0-9]/,$p')

if [[ -z $output ]]; then
	echo "Error: No '# vX.X.X -' line found in Claude output"
	exit 1
fi

echo "Raw output:"
echo "$output"

# Extract title from first line (format: "# vX.X.X - Creative Title")
title=$(echo "$output" | head -1 | sed 's/^# //')
body=$(echo "$output" | tail -n +2)

# Append changelog details section
body=$(printf '%s\n\n<details>\n<summary>Changelog</summary>\n\n%s\n</details>' "$body" "$changelog")

# Write parsed results to output directory
echo "$title" >"$output_dir/title"
echo "$body" >"$output_dir/notes"
echo "Wrote title and notes to $output_dir"
