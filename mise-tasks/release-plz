#!/usr/bin/env bash
# shellcheck shell=bash
set -euxo pipefail

DRY_RUN="${DRY_RUN:-0}"

crates=(clx ensembler xx)

crate_version_published() {
  local crate="$1" version="$2"
  curl -fsS "https://crates.io/api/v1/crates/${crate}/${version}" >/dev/null 2>&1
}

publish_crate_if_needed() {
  echo "Deprecated local publish path; sub-crate publishing now happens in the cloned upstream repo"
}

# Clone upstream repo for a sub-crate, bump its version and changelog, open a PR
process_subcrate_upstream() {
  local crate="$1"
  local upstream_url
  # Prefer repository URL from the crate's Cargo.toml
  upstream_url="$(grep '^repository\s*=\s*"' "$crate/Cargo.toml" | head -n1 | cut -d '"' -f2 || true)"
  if [[ -z "$upstream_url" ]]; then
    case "$crate" in
      clx) upstream_url="https://github.com/jdx/clx.git" ;;
      ensembler) upstream_url="https://github.com/jdx/ensembler.git" ;;
      xx) upstream_url="https://github.com/jdx/xx.git" ;;
      *) echo "Unknown upstream for $crate" ; return 0 ;;
    esac
  fi

  local tmpdir
  tmpdir="$(mktemp -d)"
  pushd "$tmpdir" >/dev/null
  git clone "$upstream_url" "$crate"
  cd "$crate"
  git fetch --tags --all

  # Detect if there are commits since last tag
  last_tag="$(git describe --tags --abbrev=0 --match 'v*' 2>/dev/null || true)"
  need_release=0
  if [[ -z "$last_tag" ]]; then
    if [[ -n "$(git rev-list --count HEAD)" ]]; then
      need_release=1
    fi
  else
    if [[ "$(git rev-list --count "${last_tag}..HEAD")" -gt 0 ]]; then
      need_release=1
    fi
  fi

  if [[ "$need_release" -eq 0 ]]; then
    echo "No new commits in upstream $crate; skipping"
    popd >/dev/null
    rm -rf "$tmpdir"
    return 0
  fi

  # Bump version and changelog on a branch
  branch_name="release/${crate}-bump"
  git checkout -B "$branch_name"
  cargo set-version --package "$crate" --bump patch
  new_version="$(grep '^version' Cargo.toml | head -n1 | cut -d '"' -f2)"
  git cliff --bump -o CHANGELOG.md
  git add Cargo.toml CHANGELOG.md
  git commit -m "chore: release v${new_version}"
  git push -u origin "$branch_name"

  # Open PR in the upstream repository
  gh pr create --title "chore: release v${new_version}" --body "Release ${crate} v${new_version}. Auto-generated from hk subtree updates." || true

  # Optionally publish immediately from upstream repo
  if [[ "${SUBCRATE_AUTO_PUBLISH:-0}" == 1 ]]; then
    cargo publish || true
    git tag "v${new_version}"
    git push --tags || true
  fi

  popd >/dev/null
  rm -rf "$tmpdir"
}

released_versions="$(git tag --list | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?$')"
cur_version="$(cargo pkgid hk | cut -d# -f2 | cut -d@ -f2)"
if ! echo "$released_versions" | grep -q "^v$cur_version$"; then
  echo "Releasing $cur_version"
  if [ "${DRY_RUN:-}" == 0 ]; then
    # Ensure subtree commits are pushed before publishing crates
    mise run subtree-sync --push-only --branch main || true

    # For sub-crates, use their upstream repos for version/changelog updates
    for crate in "${crates[@]}"; do process_subcrate_upstream "$crate"; done

    # Temporarily replace path dependencies with version dependencies for publishing
    cp Cargo.toml Cargo.toml.bak
    
    # Get the current versions of the workspace members from their local Cargo.toml files
    xx_version="$(grep '^version' xx/Cargo.toml | cut -d'"' -f2)"
    clx_version="$(grep '^version' clx/Cargo.toml | cut -d'"' -f2)"
    ensembler_version="$(grep '^version' ensembler/Cargo.toml | cut -d'"' -f2)"
    
    # Replace path dependencies with version dependencies
    sed -i "s/clx = { path = \"clx\" }/clx = \"$clx_version\"/" Cargo.toml
    sed -i "s/ensembler = { path = \"ensembler\" }/ensembler = \"$ensembler_version\"/" Cargo.toml
    sed -i "s/xx = { path = \"xx\", features = \[\"http\", \"hash\", \"rustls\"\] }/xx = { version = \"$xx_version\", features = [\"http\", \"hash\", \"rustls\"] }/" Cargo.toml
    
    # Publish the crate
    cargo publish -p hk --allow-dirty || {
      # Restore original Cargo.toml on failure
      mv Cargo.toml.bak Cargo.toml
      exit 1
    }
    
    # Restore original Cargo.toml
    mv Cargo.toml.bak Cargo.toml
    
    changelog="$(git cliff --tag "v$cur_version" --strip all --unreleased)"
    git tag "v$cur_version"
    git push --tags
    gh release create "v$cur_version" --title "v$cur_version" --notes "$changelog"
  fi
  exit 0
fi

version="$(git cliff --bumped-version)"
changelog="$(git cliff --bump --unreleased --strip all)"

if [ "$DRY_RUN" -ne 0 ]; then
  echo "version: $version"
  echo "changelog: $changelog"
  exit 0
fi

# If there is no new version to bump (i.e., equal to current), skip creating a release PR
if [ "$version" = "v$cur_version" ]; then
  echo "No unreleased changes detected for hk; skipping release PR creation."
  exit 0
fi

git cliff --bump -o CHANGELOG.md
cargo set-version --package hk "${version#v}"

git config user.name mise-en-dev
git config user.email 123107610+mise-en-dev@users.noreply.github.com
cargo update

# Ensure subtrees are up-to-date locally before creating the release PR
mise run subtree-sync --pull-only --branch main

# Do not touch sub-crate versions/changelogs in this repository

# Regenerate rendered artifacts (CLI docs, usage, etc.) for the release
mise run render
git add \
  Cargo.* \
  CHANGELOG.md \
  docs \
  hk.usage.kdl \
  hk.pkl \
  src

git checkout -B release
git commit -m "chore: release $version"
git push origin release --force
gh pr create --title "chore: release $version" --body "$changelog" --label "release" ||
  gh pr edit --title "chore: release $version" --body "$changelog"

# Push subtree changes to respective repositories
mise run subtree-sync --push-only --branch main
