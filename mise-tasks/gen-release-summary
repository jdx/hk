#!/usr/bin/env bash
# shellcheck shell=bash
#MISE description="Generate editorialized release notes using Claude Code"
#USAGE arg "<version>"
#USAGE arg "[prev_version]"
set -euo pipefail

version="${usage_version}"
prev_version="${usage_prev_version:-}"

# Get the git-cliff changelog for context
changelog=$(git cliff --unreleased --strip all 2>/dev/null || echo "")

if [[ -z $changelog ]]; then
	echo "Error: No unreleased changes found" >&2
	exit 1
fi

# Use Claude Code to editorialize the release notes
# Sandboxed: only read-only tools allowed (no Bash, Edit, Write)
claude -p \
	--model claude-sonnet-4-20250514 \
	--output-format text \
	--allowedTools "Read,Grep,Glob" \
	<<EOF
You are writing release notes for hk version ${version}${prev_version:+ (previous version: ${prev_version})}.

hk is a git hook manager and project linting tool written in Rust with emphasis on performance and concurrent execution.

Here is the raw changelog from git-cliff:
${changelog}

Rewrite this into user-friendly release notes. The format should be:

1. Start with 1-2 paragraphs summarizing the most important changes
2. Then organize into sections like "### Highlights", "### Bug Fixes", etc.
3. Write in clear, user-focused language (not developer commit messages)
4. Explain WHY changes matter to users, not just what changed
5. Group related changes together logically
6. Skip minor/internal changes that don't affect users
7. Include contributor attribution where appropriate (@username)

Keep the tone professional but approachable. Focus on what users care about.

Output ONLY the editorialized release notes, no preamble.
EOF
